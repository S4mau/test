<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lively Quiz â€“ Boss Mode</title>

<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
  :root{
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.15);
    --speed:300ms;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    display:flex; align-items:center; justify-content:center;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: linear-gradient(135deg, #8EC5FC 0%, #E0C3FC 100%);
  }
.wrap{
  width:min(1000px, 94vw);
  background:#000000; 
  border-radius:20px; 
  box-shadow:var(--shadow);
  padding:14px;
    transform: scale(1.15);       /* 1.1 = 110% zoom */
  transform-origin: top center; /* makes it scale from top */
   outline: 4px solid #ffffff; /* any color you like */
  outline-offset: 0,8px;        /* optional, pushes it away from edge */
  .wrap {
  margin-top: 80px; /* adjust if needed */
}
}

  /* BATTLE UI (Deltarune-ish feel for avatars only) */
  .battle{
    display:flex; justify-content:space-between; align-items:flex-end;
    gap:20px; margin-bottom:16px; padding:8px 6px;
  }
  .side{ width:48%; text-align:center; position:relative }
  .avatar{
    width:120px; height:120px; object-fit:cover; border-radius:6px;
    border:4px solid rgba(0,0,0,.12); background:#000; display:inline-block;
  }
  .name{ font-weight:800; margin-top:8px; letter-spacing:.6px }
  .hpwrap{ width:100%; margin-top:6px; display:flex; justify-content:center }
  .hpbar{ width:84%; height:12px; background:#eee; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04) }
  .hpfill{ height:100%; width:100%; background:#55efc4; transition:width 300ms linear }
  .hptext{ font-weight:800; margin-left:8px; font-size:13px }

  /* overlay static (full area) */
  #staticOverlay{
    position:fixed; inset:0; pointer-events:none; display:none; z-index:1200;
    background-image:url('assets/boss_static.gif'); background-size:cover; opacity:.80; mix-blend-mode:screen;
  }

  /* ad modal */
  .ad-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1300; align-items:center; justify-content:center }
  .ad-card{ width:min(490px,94vw); background:#111; padding:12px; border-radius:10px; text-align:center }
  .ad-card video{ width:100%; height:auto; display:block; }
  .ad-close{ margin-top:8px; padding:8px 12px; font-weight:800; border-radius:8px; border:none; cursor:pointer }

  /* bonus modal */
  .bonus-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1400; align-items:center; justify-content:center }
  .bonus-card{ width:min(680px,94vw); background:#fff; padding:18px; border-radius:12px }
  .bonus-opts{ display:grid; gap:8px; margin-top:12px }

  /* header / tracker (existing) */
  .top{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:12px; flex-wrap:wrap;
  }
.badge {
  background: #000000; 
  color: #6effff; 
  font-weight: 700;
  padding: 8px 12px; 
  border-radius: 999px; 
  font-size: 14px;
  border: 2px solid white;   /* added outline */
}

#scoreBadge { 
  background: #000000; 
  color: #1f7a3a; 
  border: 2px solid white;   /* added outline */
}

  /* timer */
  .timerRow{ display:flex; align-items:center; gap:10px; margin:8px 0 20px }
  #timerText{ font-weight:700 }
  .bar{ flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04) }
  .fill{ height:100%; width:100%; background:#ff1d99; transition:width linear }

  /* question box */
  .card{
    background:#000000; padding:24px; border-radius:var(--radius);
    text-align:center; font-weight:800; font-size:22px; min-height:92px;
    display:flex; align-items:center; justify-content:center;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
     border: 2px solid white; /* white outline */
  }
  .fade-in{ animation:fadeIn .28s ease both }
  .fade-out{ animation:fadeOut .22s ease both }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
  @keyframes fadeOut{ from{opacity:1} to{opacity:0; transform:translateY(-6px)} }

  /* answers grid */
  .answers{ margin-top:16px; display:grid; grid-template-columns:1fr; gap:12px }
  @media (min-width:640px){ .answers{ grid-template-columns:1fr 1fr } }
  .btn{
    border:none; border-radius:14px; padding:16px; font-size:18px; font-weight:700;
    color:#fff; cursor:pointer; transition:transform var(--speed), filter var(--speed), box-shadow var(--speed);
    box-shadow:0 6px 18px rgba(0,0,0,.08);
  }
  .btn:hover{ transform:translateY(-2px) scale(1.02); filter:brightness(1.07) }
  .btn:disabled{ opacity:1; cursor:default; transform:none; filter:none }

  /* feedback states */
  .correct{ background:#00FFC6 !important; color:#fff !important; }
  .wrong{ background:#FF4FA2 !important; color:#fff !important; animation:shake .22s linear 2 }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
  .flash{ animation:flash 480ms ease both }
  @keyframes flash{ 0%{ box-shadow:0 0 0 0 rgba(40,167,69,.6) } 100%{ box-shadow:0 0 0 16px rgba(40,167,69,0) } }

 
  /* scoreboard */
  #board{ display:none; text-align:center; margin-top:10px }
  #board h2{ margin:8px 0 14px }
  .line{ opacity:0; transform:translateY(8px); transition:opacity .7s, transform .7s; font-size:18px; }
  .reveal{ opacity:1; transform:none }
  .actions{ margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap }
  .ghost{ background:#111; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer; transition:transform var(--speed), filter var(--speed); box-shadow:var(--shadow) }
  .ghost:hover{ transform:translateY(-1px) }

.c1 { background:#a29bfe; border: 2px solid white; }
.c2 { background:#81ecec; border: 2px solid white; }
.c3 { background:#ff7675; border: 2px solid white; }
.c4 { background:#fdcb6e; border: 2px solid white; }


  /* small screen tweaks */
  @media (max-width:640px){
    .avatar{ width:96px; height:96px }
    .card{ font-size:20px; min-height:100px }
    .btn{ font-size:18px; padding:14px }
  }



.bonus-opts button {
  background: #111;
  color: #fff;
  border: 2px solid white;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 700;
  cursor: pointer;
}

#victoryScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: black;
  color: white;
  font-size: 6em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 1.5s ease; /* slower fade-in (5s instead of 3s) */
  letter-spacing: -1px; /* or 2px, or normal */

}
#victoryScreen.show {
  opacity: 1;
  pointer-events: auto;
}
body, .wrap, .card, .answers, .top, .timerRow, .badge, #board, .line, .toast {
  color: white !important;
}

.bonus-card {
  background: #000;           /* black background */
  border: 2px solid white;    /* white outline */
  color: #fff;                /* text color */
  border-radius: 12px;
  padding: -100px;
    width: 300px; 
  display: flex;              /* make it flex */
  flex-direction: column;     /* stack question + answers vertically */
  align-items: center;        /* center horizontally */
  justify-content: center;    /* center vertically */
  text-align: center;         /* just in case */
  gap: 12px;                  /* space between question and answers */
}

#bonusQ {
  font-size: 28px; /* bigger text */
  font-weight: 300; /* optional: make it bold */
  text-align: center; /* keep it centered */
}


body {
  background-image: url('assets/background.jpg');
  background-size: cover;       /* fills the screen */
  background-position: center;  /* centers it */
  background-repeat: no-repeat; /* no tiling */
}


* {
    font-family: 'VT323', monospace !important;
}

* {
  font-weight: normal !important;
  text-shadow: none !important;
}


body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: url("assets/curtain.png") no-repeat center center;
  background-size: cover;
  transform: translateY(0);
  z-index: 9999;
  animation: curtainUp 1.5s ease forwards;
}

@keyframes curtainUp {
  0%   { transform: translateY(0); }
  100% { transform: translateY(-100%); }
}


 header {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    background: red;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 1.8em;
    font-weight: bold;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px; /* space between title and menu */
  }

  .menu-link {
    color: white;
    text-decoration: none;
    font-size: 0.8em;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .menu-link:hover {
    text-decoration: underline;
  }

  .menu-icon {
    width: 20px;
    height: 20px;
  }

  body {
    margin-top: 70px; /* to prevent content from hiding behind fixed header */
  }

  </style>
</head>
  <body>



<header style="background: red; color: white; padding: 15px; text-align: center; font-size: 1.8em; font-weight: bold;">
   QuizMaster
  <a href="menu.html" class="menu-link">
    <img src="funny.ico" alt="Menu Icon" class="menu-icon">
    Menu
  </a>
</header>



<div id="quizContainer">
 


<div id="victoryScreen"><span id="victoryText"></span></div>
<div id="toastMessage" class="toast"></div>
<audio id="bgm" src="/assets/sounds/tenna_theme.mp3" autoplay loop></audio>
  <!-- Static overlay (boss ability) -->
  <div id="staticOverlay" aria-hidden="true"></div>

<!-- Overlay container (put this inside your game wrapper) -->
<div id="overlay-container"></div>



  <!-- Ad modal (boss ability) -->
  <div id="adModal" class="ad-modal">
    <div class="ad-card">
      <video id="adVideo" controls></video>
      <button id="adClose" class="ad-close">Close Ad (click)</button>
    </div>
  </div>

  <!-- Bonus question modal (boss ability) -->
  <div id="bonusModal" class="bonus-modal">
    <div class="bonus-card">
      <div id="bonusQ">Bonus question here</div>
      <div id="bonusOpts" class="bonus-opts"></div>
    </div>
  </div>

  <div class="wrap" id="app">
    <!-- BATTLEFIELD (placed above quiz) -->
    <div class="battle" id="battle">
      <div class="side" id="playerSide">
        <img id="playerAvatar" class="avatar" src="assets/player_idle.gif" alt="Player">
        <div class="name">You</div>
        <div class="hpwrap"><div class="hpbar"><div id="playerHpFill" class="hpfill"></div></div><div class="hptext" id="playerHpText">HP</div></div>
      </div>

      <div class="side" id="bossSide">
        <img id="bossAvatar" class="avatar" src="assets/boss_idle.gif" alt="Mr. Ant Tenna">
        <div class="name">Mr. Ant Tenna</div>
        <div class="hpwrap"><div class="hpbar"><div id="bossHpFill" class="hpfill" style="background:#ff7675"></div></div><div class="hptext" id="bossHpText">HP</div></div>
      </div>
    </div>

    <!-- original header / tracker -->
    <div class="top">
      <div class="badge" id="qBadge">Question 1/1</div>
      <div class="badge" id="scoreBadge">Score: <span id="score">0</span></div>
    </div>

    <div class="timerRow">
      <div id="timerText">Time: <span id="time">15</span>s</div>
      <div class="bar"><div class="fill" id="fill"></div></div>
    </div>

    <div class="card fade-in" id="question">Loadingâ€¦</div>

    <div class="answers" id="answers"></div>
    <div id="board">
  </div>

  </div>


  <audio id="sfxClick" src="assets/sounds/sfx_click.ogg" preload="auto"></audio>
<audio id="sfxPlayerHurt" src="assets/sounds/sfx_player_hurt.wav"preload="auto"></audio>
<audio id="sfxBossHurt" src="assets/sounds/sfx_boss_hurt.wav"preload="auto"></audio>
<audio id="victoryMusic" src="assets/sounds/victory_theme.mp3" preload="auto" loop></audio>
<audio id="bonus" src="assets/sounds/sfx_bonusquestion.wav" preload="auto" ></audio>
<audio id="static" src="assets/sounds/sfx_static.wav" preload="auto" ></audio>
<script>
/* ---------------- DATA (add your own Qs easily) ---------------- */
const QUESTIONS = [
  { q: "What is 2 + 2?", opts:["3","4","5","22"], correct:"4" },
  { q: "Capital of France?", opts:["Berlin","Madrid","Paris","Rome"], correct:"Paris" },
  { q: "Fastest land animal?", opts:["Horse","Cheetah","Tiger","Lion"], correct:"Cheetah" },
  { q: "Which gas do plants breathe in?", opts:["Oxygen","Carbon Dioxide","Nitrogen","Helium"], correct:"Carbon Dioxide" },
  { q: "HTML stands forâ€¦", opts:["HyperText Markup Language","Home Tool Markup Language","Hyperlinks and Text Markup Language","Hot Mail"], correct:"HyperText Markup Language" },
  { q: "CSS is used forâ€¦", opts:["Database","Styling","Server","AI"], correct:"Styling" },
  { q: "JS canâ€¦", opts:["Style pages","Add interactivity","Host servers","Make coffee"], correct:"Add interactivity" },
  { q: "1 KB equalsâ€¦", opts:["100 bytes","1024 bytes","2048 bytes","512 bytes"], correct:"1024 bytes" },
];

/* BONUS pool (off-topic questions) */
const BONUS_QUESTIONS = [
  { q: "Who's the main villain in FNAF?", opts:["Freddy","Springtrap","Glitchtrap","Purple Guy"], correct:"Springtrap" },
  { q: "What color is Spamton's tie?", opts:["Red","Yellow","Blue","Green"], correct:"Blue" },
  { q: "Deltarune made by?", opts:["Toby Fox","Nintendo","Square Enix","Epic Games"], correct:"Toby Fox" }
];

/* ---------------- ASSETS (ads) ---------------- */
const ADS = [
  'assets/ads/ad1.mp4','assets/ads/ad2.mp4','assets/ads/ad3.mp4','assets/ads/ad4.mp4',
  'assets/ads/ad5.mp4','assets/ads/ad6.mp4','assets/ads/ad7.mp4','assets/ads/ad8.mp4'
];

/* ---------------- STATE ---------------- */
let order = [];               // question indices
let qi = 0;                   // current question index (into order)
let score = 0;
let streak = 0;
let longestStreak = 0;
let correctCount = 0;
let wrongCount = 0;
let startTime = 0;
let timerId = null;
let timeLeft = 10;
const TIME_PER_Q = 10;
/*STAT*/
/* BATTLE STATE */
let playerHP =10; // you can tweak
let bossHP = 1;  // stronger than player
const MAX_PLAYER_HP = playerHP;
const MAX_BOSS_HP = bossHP;
let bossCooldownId = null;
let bossActive = true;
let bonusActive = false;

/* ---------------- DOM ---------------- */
const qBadge = document.getElementById('qBadge');
const scoreEl = document.getElementById('score');
const questionEl = document.getElementById('question');
const answersEl = document.getElementById('answers');
const timeEl = document.getElementById('time');
const fillEl = document.getElementById('fill');
const toastEl = document.getElementById('toast');

const board = document.getElementById('board');
const Lscore = document.getElementById('Lscore');
const Lcorrect = document.getElementById('Lcorrect');
const Lwrong = document.getElementById('Lwrong');
const Lstreak = document.getElementById('Lstreak');
const Ltime = document.getElementById('Ltime');

const playerAvatar = document.getElementById('playerAvatar');
const bossAvatar = document.getElementById('bossAvatar');
const playerHpFill = document.getElementById('playerHpFill');
const bossHpFill = document.getElementById('bossHpFill');
const playerHpText = document.getElementById('playerHpText');
const bossHpText = document.getElementById('bossHpText');

const staticOverlay = document.getElementById('staticOverlay');
const adModal = document.getElementById('adModal');
const adVideo = document.getElementById('adVideo');
const adClose = document.getElementById('adClose');
const bonusModal = document.getElementById('bonusModal');
const bonusQEl = document.getElementById('bonusQ');
const bonusOptsEl = document.getElementById('bonusOpts');

/* ---------------- UTIL ---------------- */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function showToast(text){
  toastEl.textContent = text;
  toastEl.style.display = 'block';
  toastEl.classList.remove('hide');
  toastEl.style.animation = 'none'; toastEl.offsetHeight; // reset
  toastEl.style.animation = null;
  setTimeout(()=> toastEl.style.display='none', 950);
}
function playSfx(id, { volume=1 } = {}){
  const a = document.getElementById(id);
  if(!a) return;
  a.pause();
  a.currentTime = 0;
  a.volume = volume;
  a.play().catch(e => console.log("Sound blocked or not loaded:", id, e));
}

/* ---------------- TIMER ---------------- */
function startTimer(){
  clearInterval(timerId);
  timeLeft = TIME_PER_Q;
  timeEl.textContent = timeLeft;
  // animate progress bar shrink
  fillEl.style.transition = `width ${TIME_PER_Q}s linear`;
  requestAnimationFrame(()=> fillEl.style.width = '0%');

  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timerId);
      lockAnswers();
      wrongCount++;
      // when time runs out, treat as wrong
      applyPlayerDamage(1);
      document.querySelectorAll('.btn').forEach(b=>{
        if(b.dataset.correct === '1'){ b.classList.add('correct'); }
      });
      setTimeout(nextQuestion, 900);
    }
  },1000);
}
function stopTimer(){
  clearInterval(timerId);
  // freeze bar at current width
  const pct = Math.max(0, timeLeft / TIME_PER_Q)*100;
  fillEl.style.transition = 'none';
  fillEl.style.width = pct+'%';
}

/* ---------------- BATTLE HELPERS ---------------- */
function updateHPBars(){
  const pPct = Math.max(0, playerHP / MAX_PLAYER_HP)*100;
  const bPct = Math.max(0, bossHP / MAX_BOSS_HP)*100;
  playerHpFill.style.width = pPct + '%';
  bossHpFill.style.width = bPct + '%';
  playerHpText.textContent = `HP: ${playerHP}/${MAX_PLAYER_HP}`;
  bossHpText.textContent = `HP: ${bossHP}/${MAX_BOSS_HP}`;
}

// REPLACE your existing setAvatar(...) with this version
// it adds 'death' states and makes idle/other states ignore when currently dead.
const avatarTimeouts = {}; // keep optional per-avatar timeouts (safe to ignore)

function setAvatar(who, state){
  // who: 'player' or 'boss', state: 'idle','attack','hurt','taunt','death'
  const map = {
    player: {
      idle: 'assets/player_idle.gif',
      attack: 'assets/player_attack.gif',
      hurt: 'assets/player_hurt.gif',
      death: 'assets/player_death.gif'   // <- make sure this file exists
    },
    boss: {
      idle: 'assets/boss_idle.gif',
      attack: 'assets/boss_attack.gif',
      hurt: 'assets/boss_hurt.gif',
      taunt: 'assets/boss_taunt.gif',
      death: 'assets/boss_death.gif', 
      winner: 'assets/w.gif'    // <- make sure this file exists
    }
  };

  const el = who === 'player' ? playerAvatar : bossAvatar;
  if(!el) return;

  // keep track of state so we can avoid overwriting death
  const current = el.dataset.state || 'idle';

  // if already dead, never override (death is final visual state)
  if(current === 'death' && state !== 'death') return;

  // set new state and src (fallback to idle if missing)
  const src = (map[who] && map[who][state]) ? map[who][state] : map[who].idle;
  el.src = src;
  el.dataset.state = state;

  // clear any pending timeouts for this avatar (prevents old timeouts flipping back)
  if(avatarTimeouts[who]){ clearTimeout(avatarTimeouts[who]); avatarTimeouts[who] = null; }
}


function applyBossDamage(dmg){
  bossHP = Math.max(0, bossHP - dmg);
  updateHPBars();

  if(bossHP <= 0){
    // Echo the last hit sound
    playEchoSfx('sfxBossHurt', 4, 150, 0.6);

    // Delay showing victory screen until echoes finish
    setTimeout(triggerVictory, 700);
  }
}
function applyPlayerDamage(dmg){
  playerHP = Math.max(0, playerHP - dmg);
  updateHPBars();
  if(playerHP <= 0) onPlayerDefeated();
}

/* ---------------- BOSS AI (random cooldown/abilities) ---------------- */
function scheduleBossAction(){
  clearTimeout(bossCooldownId);
  if(!bossActive) return;
  const delay = 1000 /*+ Math.floor(Math.random()*6000);*/ // 8-14s
  bossCooldownId = setTimeout(()=>{
    bossDoRandomAbility();
    scheduleBossAction();
  }, delay);
}

function bossDoRandomAbility(){
  const abilities = ['basic','static','ad','bonus'];
  // weights (basic more likely)
  const weights = [50,20,15,15];
  const total = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*total; let idx=0; while(r>weights[idx]){ r-=weights[idx]; idx++; }
  const chosen = abilities[idx];
  if(chosen === 'basic') bossBasicAttack();
  if(chosen === 'static') bossStaticOverlay();
  if(chosen === 'ad') bossPopupAd();
  if(chosen === 'bonus') bossBonusQuestion();
}


function bossBasicAttack(){
  // boss does a normal hit
  setAvatar('boss','attack');
  setTimeout(()=> setAvatar('boss','idle'), 900);
  applyPlayerDamage(1);
   playSfx('sfxPlayerHurt');
 playTennaVoice();
}


function bossStaticOverlay(){
  staticOverlay.style.display = 'block';
  setTimeout(()=>{ staticOverlay.style.display='none'; }, 4200);
  setAvatar('boss','taunt');
  setTimeout(()=> setAvatar('boss','idle'), 1200);
  playSfx('static');
 playTennaVoice();
}

function bossPopupAd(){
  // choose random ad and show modal, player must click to close
  const idx = Math.floor(Math.random()*ADS.length);
  adVideo.src = ADS[idx];
  adModal.style.display = 'flex';
  stopTimer(); // pause quiz timer
  adVideo.play();
  setAvatar('boss','taunt');
playTennaVoice();
}

function bossBonusQuestion(){
  // show a separate bonus modal (player must answer to damage the boss)
  const bq = BONUS_QUESTIONS[Math.floor(Math.random()*BONUS_QUESTIONS.length)];
  bonusQEl.textContent = bq.q;
  bonusOptsEl.innerHTML = '';
  const opts = shuffle([...bq.opts]);
  playSfx('bonus');
  opts.forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = 'btn c2';
    btn.textContent = opt;
    btn.onclick = ()=>{
      playSfx('sfxClick');   // ðŸ”Š play click sound when choosing answer
      handleBonusAnswer(btn, bq.correct);
    };
    bonusOptsEl.appendChild(btn);
  });
  bonusModal.style.display = 'flex';
  stopTimer();
  setAvatar('boss','taunt');
 playTennaVoice();
}


/* ---------------- BONUS HANDLING ---------------- */
function handleBonusAnswer(btn, correct){
  const isRight = btn.textContent === correct;
  // disable buttons
  bonusOptsEl.querySelectorAll('button').forEach(b=> b.disabled=true);
  if(isRight){
    btn.classList.add('correct');
    applyBossDamage(2);
    setAvatar('player','attack');
    setTimeout(()=> setAvatar('player','idle'), 700);
    showToast('Nice! boss takes 2 damage');
  } else {
    btn.classList.add('wrong');
    applyPlayerDamage(2);
    setAvatar('player','hurt');
    setTimeout(()=> setAvatar('player','idle'), 700);
    showToast('Oof! you took 2 damage');
  }
  // close bonus
  setTimeout(()=>{ bonusModal.style.display='none'; startTimer(); }, 900);
}

/* AD modal close */
adClose.addEventListener('click', ()=>{
  adModal.style.display = 'none';
  adVideo.pause(); adVideo.currentTime = 0;
  startTimer();
});

/* ---------------- QUIZ FLOW (integrated) ---------------- */
function start(reshuffle=true){
  score = 0; streak = 0; longestStreak = 0; correctCount = 0; wrongCount = 0;
  qi = 0;
  order = Array.from({length: QUESTIONS.length}, (_,i)=>i);
  if(reshuffle) shuffle(order);
  scoreEl.textContent = score;
  board.style.display = 'none';
  questionEl.style.display = 'flex';
  answersEl.style.display = 'grid';
  document.querySelector('.timerRow').style.display='flex';
  startTime = performance.now();
  

  // reset battle
  playerHP = MAX_PLAYER_HP; bossHP = MAX_BOSS_HP; bossActive = true;
  updateHPBars();
  setAvatar('player','idle'); setAvatar('boss','idle');
  scheduleBossAction();

  renderQuestion();
  
}

function renderQuestion(){
  // if boss still alive but questions finished, restart from first
  if(qi >= order.length){
    if(bossHP > 0){
      qi = 0; // reset back to first question
      shuffle(order); // optional: reshuffle each loop
    } else {
      return finish(); // boss is dead, end game
    }
  }

  // question card swap animation
  questionEl.classList.remove('fade-in'); questionEl.classList.add('fade-out');
  setTimeout(()=>{
    const q = QUESTIONS[order[qi]];
    questionEl.textContent = q.q;
    questionEl.classList.remove('fade-out'); questionEl.classList.add('fade-in');

    // tracker
    qBadge.textContent = `Question ${qi+1}/${order.length}`;
    // answers
    answersEl.innerHTML = '';
    const opts = shuffle([...q.opts]);
    const colorClasses = shuffle(['c1','c2','c3','c4']); // random color per render
    opts.forEach((opt, idx)=>{
      const btn = document.createElement('button');
      btn.className = `btn ${colorClasses[idx]}`;
      btn.textContent = opt;
      btn.dataset.correct = (opt === q.correct) ? '1':'0';
      btn.onclick = ()=> choose(btn);
      answersEl.appendChild(btn);
    });

    // reset / start timer
    fillEl.style.width = '100%';
    startTimer();
    // update score badge (already shown)
    scoreEl.textContent = score;
  }, 180);
}

function lockAnswers(){
  document.querySelectorAll('.btn').forEach(b=> b.disabled = true);
}

function choose(btn){
  if(btn.disabled) return;
  playSfx('sfxClick');

  stopTimer();
  lockAnswers();

  const isCorrect = btn.dataset.correct === '1';
  if(isCorrect){
    btn.classList.add('correct','flash');
    streak++;
    longestStreak = Math.max(longestStreak, streak);

    // streak bonus: +1 base + bonus every 3 streak (Ã—1, Ã—2, â€¦)
    const bonus = Math.floor(streak/3); // 0,1,2â€¦
    const gained = 1 + bonus;
    score += gained;
    scoreEl.textContent = score;

    if(bonus>=1) showToast(`ðŸ”¥ STREAK x${bonus+1}! +${gained}`);

    // player attacks boss
    setAvatar('player','attack');
    setTimeout(()=> setAvatar('player','idle'), 700);
    applyBossDamage(1 + Math.floor(streak/5)); // small scaling with streak
    playSfx('sfxBossHurt');


  }else{
    btn.classList.add('wrong');
    // reveal correct
    document.querySelectorAll('.btn').forEach(b=>{
  if(b.dataset.correct === '1'){
    b.classList.add('correct');
  } else {
    b.classList.add('wrong');
  }
});

    streak = 0;
    wrongCount++;

    // boss punishes
    setAvatar('boss','attack');
    setTimeout(()=> setAvatar('boss','idle'), 900);
    applyPlayerDamage(1);
    playSfx('sfxPlayerHurt');

  }
  if(isCorrect) correctCount++;

  setTimeout(nextQuestion, 950);
}

function nextQuestion(){
  qi++;
  renderQuestion();
}

function finish(){
  stopTimer();
  bossActive = false; clearTimeout(bossCooldownId);
  // hide quiz UI
  questionEl.style.display = 'none';
  answersEl.style.display = 'none';
  document.querySelector('.timerRow').style.display='none';

  // compute time
  const totalSeconds = Math.round((performance.now() - startTime)/1000);

  // fill scoreboard text
  Lscore.textContent   = `Score: ${score} / ${order.length}`;
  Lcorrect.textContent = `Correct: ${correctCount}`;
  Lwrong.textContent   = `Incorrect: ${wrongCount}`;
  Lstreak.textContent  = `Longest streak: ${longestStreak}`;
  Ltime.textContent    = `Total time: ${totalSeconds}s`;

  // show board with slow line-by-line reveal
  board.style.display = 'block';
  const lines = [Lscore, Lcorrect, Lwrong, Lstreak, Ltime];
  lines.forEach((el,i)=> setTimeout(()=> el.classList.add('reveal'), 350*i));
}

/* retry buttons */
function restart(reshuffle){
  // reset scoreboard reveal
  document.querySelectorAll('#board .line').forEach(el=>{
    el.classList.remove('reveal');
  });
  start(reshuffle);
}


updateHPBars();
document.body.addEventListener('click', ()=>start(true), { once:true });



// SOUND HELPERS
function playSfx(id, { volume=1 } = {}) {
  const a = document.getElementById(id);
  if(!a) return;
  try {
    a.pause();
    a.currentTime = 0;
    a.volume = volume;
    a.play().catch(()=>{}); // ignore blocked autoplay until user interacts
  } catch(e){}
}


function playMusic(id, { volume=1, loop=false } = {}){
  const m = document.getElementById(id);
  if(!m) return;
  try{
    m.pause();
    m.currentTime = 0;
    m.loop = !!loop;
    m.volume = volume;
    m.play().catch(()=>{ m.muted = true; m.play().catch(()=>{}); }); // fallback
  }catch(e){}
}

function stopMusic(id){
  const m = document.getElementById(id);
  if(!m) return;
  try{ m.pause(); m.currentTime = 0; }catch(e){}
}




function triggerVictory(){
  bossActive = false;
  clearTimeout(bossCooldownId);
  stopTimer();
  document.getElementById("app").style.display = "none";

  // fade out boss music
  const bossMusic = document.getElementById("bgm");
  if (bossMusic) {
    let fade = setInterval(()=>{
      if (bossMusic.volume > 0.05) {
        bossMusic.volume -= 0.05;
      } else {
        bossMusic.pause();
        bossMusic.currentTime = 0;
        clearInterval(fade);
      }
    }, 200); // fades every 200ms
  }

  // play victory theme
  const victoryMusic = document.getElementById("victoryMusic");
  if (victoryMusic) {
    victoryMusic.volume = 0;
    victoryMusic.play().catch(()=>{});
    // fade in victory
    let up = setInterval(()=>{
      if (victoryMusic.volume < 0.95) {
        victoryMusic.volume += 0.05;
      } else {
        clearInterval(up);
      }
    }, 200);
  }

  // black screen + text
  const v = document.getElementById("victoryScreen");
  v.classList.add("show");  
  setTimeout(()=> revealVictoryText("YOU WON", 300), 1000);
}




function playEchoSfx(id, repeats=3, delay=120, decay=0.6){
  const orig = document.getElementById(id);
  if(!orig) return;
  for(let i=0;i<repeats;i++){
    setTimeout(()=>{
      const clone = orig.cloneNode();
      clone.volume = Math.pow(decay, i); // decay volume each echo
      clone.play().catch(()=>{});
    }, i*delay);
  }
}

function revealVictoryText(text = "YOU WON") {
  const v = document.getElementById("victoryScreen");
  v.innerHTML = ""; // clear previous

  text.split("").forEach((char, i) => {
    const span = document.createElement("span");
    span.textContent = char === " " ? "\u00A0" : char; // non-breaking space
    span.style.opacity = 0;
    span.style.transition = "opacity 1s"; // fade duration
    v.appendChild(span);

    // show letter after delay * index
    setTimeout(() => {
      span.style.opacity = 1;
    }, i * 500); // 1000ms = 1 second between letters
  });
}

 document.body.addEventListener('click', ()=>{
    const bgm = document.getElementById('bgm');
    bgm.muted = false;
    bgm.play().catch(()=>{});
  }, { once:true });



const tennaVoices = [
  "assets/sounds/tenna_voice-1.mp4",
  "assets/sounds/tenna_voice-2.mp4"
];

function playTennaVoice() {
  const pick = tennaVoices[Math.floor(Math.random() * tennaVoices.length)];
  new Audio(pick).play();
}

function showToast(message) {
  const toast = document.getElementById("toastMessage");
  if (toast) {
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  } else {
    console.warn("Toast element not found! Message:", message);
  }
}

function showToast(message) {
  const toast = document.getElementById("toastMessage");
  if (toast) {
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  } else {
    console.warn("Toast element not found! Message:", message);
  }
}

function onPlayerDefeated() {
  bossActive = false;
  clearTimeout(bossCooldownId);

  // defeat message
  showToast('');

  // change sprites
  setAvatar('player', 'death');
  setAvatar('boss', 'winner');

  // auto reload after 2 seconds
  setTimeout(() => {
    location.reload();
  }, 2000);
}



</script>
</body>
</html>
