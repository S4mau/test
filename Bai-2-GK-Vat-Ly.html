<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Image-backed Quiz ‚Äî Multi-type Demo (Second Chance)</title>
<style>
:root{
  --bg-top: #e7f9fb;    /* pale sky */
  --bg-bottom: #f6efe0; /* warm sand */
  --card: #fff8f0;      /* soft sand card */
  --muted: #355258;     /* darker muted text for contrast */
  --accent-sea: #0b7a78;/* teal sea accent (menu vibe) */
  --accent-sea-2:#056a64; /* darker teal */
  --sun: #ffb703;       /* warm highlight */
  --ok: #1e693f;
  --bad: #a32727;
  --header-height: 72px;
}

/* ---------- PAGE BASE (layout preserved) ---------- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg-top) 0%, var(--bg-bottom) 100%);
  color:var(--muted);
  transition:background .45s,color .45s}
body {
  /* REMOVE display: flex; align-items: center; justify-content: center; */
  display: block; 
  min-height: 100%;
  margin: 0;
  font-family: Inter, system-ui, Arial, sans-serif;
  background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
  color: var(--muted);
  transition: background .45s, color .45s;

  /* NEW PADDING SETTINGS */
  padding: 18px;
  /* This pushes ALL content down below the 72px header + extra space */
  padding-top: calc(var(--header-height) + 24px); 
}
/* ---------- TOP HEADER (teal menu vibe, readable) ---------- */
header{
  position: fixed;
  top: 0; left: 0; right:0;
  height: var(--header-height);
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 26px; z-index:9999;
  background: linear-gradient(90deg, var(--accent-sea), var(--accent-sea-2));
  color: #fff; font-weight:800;
  box-shadow: 0 8px 30px rgba(7,50,50,0.14);
  backdrop-filter: blur(6px) saturate(1.05);
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

/* left title area (sun icon preserved if you had it) */
header > div:first-child{font-size:0.95rem;color:rgba(255,255,255,0.96);display:flex;gap:10px;align-items:center}
/* header links: clear contrast and no white background */
header a{ color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px;
  background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.04); font-weight:700; }

/* ensure content sits below fixed header */
.wrap{ margin-top: calc(var(--header-height) + 12px); }

/* ---------- MAIN WRAP (soft sand, no layout changes) ---------- */
.wrap {
  /* REMOVE margin-top: calc(var(--header-height) + 12px); */
  
  /* Keep these: */
  width: min(1100px, 96vw);
  border-radius: 12px;
  padding: 14px;
  background: linear-gradient(180deg, var(--card) 0%, #fbf3e6 100%);
  box-shadow: 0 16px 48px rgba(9, 40, 40, 0.06);
  border: 1px solid rgba(6, 80, 80, 0.04);
  transition: background .35s, box-shadow .35s, border-color .35s;

  /* NEW MARGIN SETTING */
  margin: 0 auto; /* This centers the box horizontally only */
}

/* inner header row inside wrap */
.wrap .header{ display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px }
.wrap .header h1{ font-size:1.05rem;margin:0;color:#05393a }
.wrap .header .stats{ display:flex; gap:10px; align-items:center }
.stat{ background: rgba(11,122,120,0.06); padding:6px 10px; border-radius:8px; font-weight:800; color:#074b48 }

/* ---------- VIEWER (sky frame) ---------- */
.viewer{ display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:12px; flex-wrap:wrap }
.vbtn{ background:transparent; color:var(--muted); border:1px solid rgba(5,50,50,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800; transition: transform .12s, box-shadow .12s; }
.vbtn:hover{ transform: translateY(-3px) }
.imgWrap{
  width:800px; max-width:90vw; height:500px; overflow:auto;
  background: linear-gradient(180deg, rgba(183,236,239,0.18), rgba(255,255,255,0.45));
  border-radius:10px; display:flex; align-items:flex-start; justify-content:flex-start;
  border: 1px solid rgba(11,122,120,0.08);
  transition: border-color .35s ease, box-shadow .35s ease, background .35s ease;
}
.imgWrap img{ width:100%; display:block; filter:none; }

/* responsive */
@media (max-width:880px){
  .viewer{ flex-direction:column }
  .imgWrap{ width:100%; height:350px; max-width:100% }
  .viewer-controls{ width:100%; justify-content:space-between }
}

/* ---------- ANSWERS (sand cards, readable text) ---------- */
.answers{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px }
@media (max-width:880px){ .answers{ grid-template-columns:1fr } }
.qcard{
  background: linear-gradient(180deg, rgba(255,250,245,0.98), rgba(255,247,240,0.98));
  padding:12px; border-radius:10px;
  border:1px solid rgba(9,40,40,0.04);
  transition: box-shadow .25s, transform .18s;
  color:#05393a;
}
.qcard:hover{ transform: translateY(-4px); box-shadow: 0 10px 26px rgba(9,40,40,0.06) }
.qhead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:#05393a; font-weight:800 }

/* options */
.opts{ display:flex; gap:8px; flex-wrap:wrap }
.opt{
  padding:8px 12px; border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,250,245,0.96));
  border:1px solid rgba(6,40,40,0.04);
  cursor:pointer; min-width:48px; text-align:center; font-weight:900; color:#05393a;
  transition: transform .12s, box-shadow .12s, background .12s;
}
.opt:hover{ transform: translateY(-4px); box-shadow: 0 8px 20px rgba(255, 255, 255, 0.06) }
.opt.selected{
  outline:3px solid rgba(11,122,120,0.22);
  background: linear-gradient(90deg,#b9f3e4,#dff7f9);
  color:#05393a;
}

.opt.correct{ background: var(--ok); color:#fff; box-shadow: 0 6px 18px rgba(30,105,63,0.08) }
.opt.wrong{ background: var(--bad); color:#fff; box-shadow: 0 6px 18px rgba(163,39,39,0.08) }

/* input & text results */
.inputText{ width:100%; padding:8px; border-radius:8px; border:1px solid rgba(9,40,40,0.06); background: #fffaf3; color:#05393a }
.textResult.badge{ margin-left:8px; padding:6px 8px; border-radius:8px; font-weight:800 }
.textResult.correct{
  background: linear-gradient(180deg,#2ec4a6,#1fa08a);
  color:#043c3a;
}

.textResult.wrong{
  background: linear-gradient(180deg,#ff7a7a,#e25555);
  color:#fff5f5;
}

/* ---------- CONTROLS + MISC ---------- */
.controls{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:8px }
.btnPrimary{ background: linear-gradient(90deg,var(--sun), #ff9b2e); color:#072226; font-weight:900; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; transition: transform .12s, box-shadow .12s; }
.btnPrimary:hover{ transform: translateY(-3px) }
.btnGhost{ background:transparent; color:var(--muted); border:1px solid rgba(6,40,40,0.06); padding:8px 12px; border-radius:10px; cursor:pointer }
.small{ font-size:0.92rem; color:#6b7880 }
.center{ display:flex; gap:8px; align-items:center }
.finalBox{ text-align:center; padding:16px; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,250,245,0.98)); border-radius:8px; margin-top:12px; border:1px solid rgba(6,40,40,0.04) }
.note{ font-size:0.9rem; color:#6b7880 }
.badge{ background: rgba(183,236,239,0.12); padding:6px 10px; border-radius:8px; color:#055055 }

/* cinematic overlay (warm sunrise colors, keeps visual) */
#cinematic-overlay .cine-bar{ background: linear-gradient(90deg, rgba(255,214,171,0.98), rgba(255,182,103,0.98)); }
.cine-title{ color:#ffffff; text-shadow:0 8px 22px rgba(255,214,171,0.10) }

/* ---------- SECOND-CHANCE THEME : NIGHT MINT ---------- */
body.second-chance{
  background: radial-gradient(circle at top,#0f2a44 0%, #081a2a 60%, #050f18 100%);
  color:#dff6f3;
}

.wrap.second-chance{
  background: linear-gradient(180deg,#0c2236,#0a1c2c);
  border-color: rgba(72,255,215,0.25);
  color:#dff6f3;
}

.wrap.second-chance .qcard{
  background: linear-gradient(180deg,#0f2a44,#0b2236);
  border-color: rgba(72,255,215,0.18);
  color:#dff6f3;
}

/* options */
.wrap.second-chance .opts .opt{
  background: linear-gradient(180deg,#102f46,#0d253a);
  border-color: rgba(72,255,215,0.22);
  color:#cffff6;
}

.wrap.second-chance .opts .opt:hover{
  background: linear-gradient(180deg,#123a55,#0f2e46);
}

.wrap.second-chance .opts .opt.selected{
  outline: 3px solid #48ffd7;
  background: linear-gradient(180deg,#164f6d,#0f3f58);
  color:#ffffff;
}

/* correct / wrong */
.wrap.second-chance .opt.correct{
  background: linear-gradient(180deg,#1fe0a3,#0fb37e);
  color:#04261c;
}

.wrap.second-chance .opt.wrong{
  background: linear-gradient(180deg,#ff6b6b,#c83b3b);
  color:#fff;
}

/* stats & buttons */
.wrap.second-chance .stat,
.wrap.second-chance .badge{
  background: rgba(72,255,215,0.18);
  color:#7fffea;
}

.wrap.second-chance .btnPrimary{
  background: linear-gradient(90deg,#48ffd7,#1fe0a3);
  color:#04261c;
}

.wrap.second-chance .btnGhost{
  background: rgba(255,255,255,0.04);
  border-color: rgba(72,255,215,0.22);
  color:#bfffee;
}
opt.wrong{ background: linear-gradient(180deg,#bd5c5c,#a83f3f); color:#fff }

/* accessibility focus */
.opt:focus{ outline:2px dashed rgba(11,122,120,0.12); outline-offset:4px }





/* FINAL RESULT BOX TEXT */
.finalBox{
  color: #000000; /* main text color */
}

/* Title: "All rounds complete üéâ" */
.finalBox h3{
  color: #0b7a78; /* headline color */
}

/* Sub text: "Total correct: 0 / 3" */
.finalBox .small{
  color: #000000;
}

/* Links / extra lines like "Review ‚Äî All questions" */
.finalBox a,
.finalBox .note{
  color: #000000;
}
</style>
</head>
<body>

<header> <!-- header intentionally outside wrap so it won't change during second chance -->
  <div style="font-size:0.95rem; font-weight:800; padding-left:6px">Your Quiz App (Header - stays same)</div>
  <div style="display:flex; gap:12px; align-items:center;">
    <a href="index.html" style="color:white; text-decoration:none; background:rgba(255,255,255,0.05); padding:6px 10px; border-radius:8px;">Menu</a>
  </div>
</header>

<div class="wrap" id="wrap">
  <div class="header">
    <h1>Image-backed Quiz ‚Äî Mixed types (Second Chance)</h1>
    <div class="stats">
      <div class="stat">Round: <span id="roundIdx">1</span>/<span id="roundTotal">2</span></div>
      <div class="stat">Score: <span id="accScore">0</span> / <span id="poolTotal">20</span></div>
    </div>
  </div>

  <div class="viewer">
    <div class="viewer-controls">
      <button class="vbtn" id="prevBtn">‚óÄ Prev</button>
    </div>
   <div class="imgWrap"><img id="viewerImg" src="assets/VatLy-Img/1-vl.png" alt="q-img" onerror="this.style.filter='grayscale(1)';"></div>
    <div class="viewer-controls">
      <button class="vbtn" id="nextBtn">Next ‚ñ∂</button>
    </div>
    <div style="width:12px"></div>
    <div class="small" id="viewerIndex">Image 1 / 19</div>
  </div>

  <section>
    <div style="display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:10px">
      <div>
        <div class="note">Use Prev/Next to read the question images. Each answer slot below corresponds to a question number (image).</div>
        <div class="note">Question types: <strong>MCQ</strong> = single A‚ÄìD, <strong>Multi</strong> = choose up to N true options, <strong>Text</strong> = type answer.</div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="btnGhost" id="retrySame">Retry Round</button>
        <button class="btnGhost" id="reshuffleAll">Reshuffle All</button>
      </div>
    </div>

    <div class="answers" id="answers"></div>

    <div class="controls">
      <div class="small">Answered: <span id="selectedCount">0</span> / <span id="perRound">10</span></div>
      <div class="center">
        <button class="btnGhost" id="confirmBtn" disabled>Confirm Answers</button>
        <button class="btnPrimary" id="nextBtnRound" style="display:none">Next Round ‚ñ∂</button>
      </div>
    </div>

    <div id="finalBoxHolder"></div>
  </section>
</div>


<audio id="sCorrect" src="assets/sounds/Correct-1.ogg" preload="auto"></audio>
<audio id="sWrong" src="assets/sounds/Incorrect-1.ogg" preload="auto"></audio>

<script>
/* ------------------ Simplified Quiz Script (auto second-chance kept) ------------------ */

const TOTAL_Q = 7;
const PER_ROUND = 10;

// --- Pool: edit as before ---
const POOL = [
 // B√ÄI 2 - P = I
{ number: 1, subject: 'C1-B1-PI', type: 'mcq', correct: 'A' },      { number: 13, subject: 'C13-B1-PI', type: 'mcq', correct: 'B' },
{ number: 2, subject: 'C2-B1-PI', type: 'mcq', correct: 'C' },      { number: 14, subject: 'C14-B1-PI', type: 'mcq', correct: 'A' },
{ number: 3, subject: 'C3-B1-PI', type: 'mcq', correct: 'A' },      { number: 15, subject: 'C15-B1-PI', type: 'mcq', correct: 'C' },
{ number: 4, subject: 'C4-B1-PI', type: 'mcq', correct: 'A' },      { number: 16, subject: 'C16-B1-PI', type: 'mcq', correct: 'B' },
{ number: 5, subject: 'C5-B1-PI', type: 'mcq', correct: 'A' },      { number: 17, subject: 'C17-B1-PI', type: 'mcq', correct: 'B' },
{ number: 6, subject: 'C6-B1-PI', type: 'mcq', correct: 'B' },      { number: 18, subject: 'C18-B1-PI', type: 'mcq', correct: 'A' },
{ number: 7, subject: 'C7-B1-PI', type: 'mcq', correct: 'B' },      { number: 19, subject: 'C19-B1-PI', type: 'mcq', correct: 'D' },
{ number: 8, subject: 'C8-B1-PI', type: 'mcq', correct: 'A' },      { number: 20, subject: 'C20-B1-PI', type: 'mcq', correct: 'C' },
{ number: 9, subject: 'C9-B1-PI', type: 'mcq', correct: 'C' },      { number: 21, subject: 'C21-B1-PI', type: 'mcq', correct: 'D' },
{ number: 10, subject: 'C10-B1-PI', type: 'mcq', correct: 'A' },    { number: 22, subject: 'C22-B1-PI', type: 'mcq', correct: 'B' },
{ number: 11, subject: 'C11-B1-PI', type: 'mcq', correct: 'D' },    { number: 23, subject: 'C23-B1-PI', type: 'mcq', correct: 'B' },
{ number: 12, subject: 'C12-B1-PI', type: 'mcq', correct: 'D' },    { number: 24, subject: 'C24-B1-PI', type: 'mcq', correct: 'A' },

// B√ÄI 2 - P = II
{ number: 25, subject: 'C25-B1-PII', type: 'multi', correct: ['A', 'C', 'D'] },   { number: 28, subject: 'C28-B1-PII', type: 'multi', correct: ['A', 'B', 'D'] },
{ number: 26, subject: 'C26-B1-PII', type: 'multi', correct: ['A', 'B', 'C'] },       { number: 29, subject: 'C29-B1-PII', type: 'multi', correct: ['A', 'B', 'D'] },
{ number: 27, subject: 'C27-B1-PII', type: 'multi', correct: ['B', 'C'] },       { number: 30, subject: 'C30-B1-PII', type: 'multi', correct: ['B', 'C', 'D'] },

// B√ÄI 2 - P = III
{ number: 31, subject: 'C31-B1-PIII', type: 'text', correct: '2.77' },  { number: 35, subject: 'C35-B1-PIII', type: 'text', correct: '0.7' },
{ number: 32, subject: 'C32-B1-PIII', type: 'text', correct: '1.5' },   { number: 36, subject: 'C36-B1-PIII', type: 'text', correct: '4' },
{ number: 33, subject: 'C33-B1-PIII', type: 'text', correct: '0.46' },   { number: 37, subject: 'C37-B1-PIII', type: 'text', correct: '121' },
{ number: 34, subject: 'C34-B1-PIII', type: 'text', correct: '0.53' },   { number: 38, subject: 'C38-B1-PIII', type: 'text', correct: '347' },

//Bo 35-38

];
// stable uid
POOL.forEach(q => q._uid = `${q.subject || 'General'}-${q.number}`);

// --- Track attempts for final report ---
const userAnswers = {}; 
// userAnswers[number] = { firstAttempt, secondAttempt, correct, type, finalIsCorrect }

// --- State ---
let shuffled = [], batches = [], currentBatchIndex = 0;
let selections = {}, revealed = false, accScore = 0, viewIndex = 1;
let secondChanceMode = false, mainWrongPool = [], secondChancePool = [];

// --- DOM ---
const answersEl = document.getElementById('answers');
const viewerImg  = document.getElementById('viewerImg');
const viewerIndex = document.getElementById('viewerIndex');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const selectedCountEl = document.getElementById('selectedCount');
const confirmBtn = document.getElementById('confirmBtn');
const nextBtnRound = document.getElementById('nextBtnRound');
const retrySameBtn = document.getElementById('retrySame');
const reshuffleAllBtn = document.getElementById('reshuffleAll');
const roundIdxEl = document.getElementById('roundIdx');
const roundTotalEl = document.getElementById('roundTotal');
const accScoreEl = document.getElementById('accScore');
const poolTotalEl = document.getElementById('poolTotal');
const perRoundEl = document.getElementById('perRound');
const finalBoxHolder = document.getElementById('finalBoxHolder');
const wrapEl = document.getElementById('wrap');

const sClick = document.getElementById('sClick');
const sCorrect = document.getElementById('sCorrect');
const sWrong = document.getElementById('sWrong');

function play(el){ try{ if(el) { el.currentTime = 0; el.play(); } }catch(e){} }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* ----------------- Pool / Batches ----------------- */
function prepareFromPool(poolArr, reshuffle = true){
  poolTotalEl.textContent = POOL.length;
  shuffled = poolArr.slice();
  if(reshuffle) shuffle(shuffled);
  batches = [];
  for(let i=0;i<shuffled.length;i+=PER_ROUND) batches.push(shuffled.slice(i, i+PER_ROUND));
  roundTotalEl.textContent = batches.length || 1;
  currentBatchIndex = 0;
}

function prepareMain(){
  accScore = 0; accScoreEl.textContent = accScore;
  mainWrongPool = []; secondChanceMode = false;
  wrapEl.classList.remove('second-chance','intro');
  document.body.classList.remove('second-chance');
  // clear previous userAnswers so report starts fresh for new run
  for(const k in userAnswers) delete userAnswers[k];
  prepareFromPool(POOL, true);
}

/* ----------------- Viewer ----------------- */



function updateViewer(){
  // load images from VatLy-Img named like: 1-vl.png, 2-vl.png, ...
  viewerImg.src = `assets/VatLy-Img/${viewIndex}-vl.png`;
  viewerIndex.textContent = `Image ${viewIndex} / ${TOTAL_Q}`;
}

viewerImg.onerror = function(){
  if(viewerImg.src && viewerImg.src.endsWith('.png')) { viewerImg.src = viewerImg.src.replace('.png','.jpg'); return; }
  this.style.filter = 'grayscale(1)';
};
function attachViewer(){
  prevBtn.addEventListener('click', ()=>{ viewIndex = Math.max(1, viewIndex-1); updateViewer(); });
  nextBtn.addEventListener('click', ()=>{ viewIndex = Math.min(TOTAL_Q, viewIndex+1); updateViewer(); });
  window.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') { viewIndex = Math.max(1, viewIndex-1); updateViewer(); }
    if(e.key === 'ArrowRight') { viewIndex = Math.min(TOTAL_Q, viewIndex+1); updateViewer(); }
  });
}

/* ----------------- Render Batch ----------------- */
function renderBatch(){
  finalBoxHolder.innerHTML = '';
  revealed = false;
  selections = {};
  answersEl.innerHTML = '';

  if(!batches || batches.length === 0){
    finalBoxHolder.innerHTML = `<div class="finalBox"><h3>No questions in this pool.</h3></div>`;
    return;
  }

  const batch = batches[currentBatchIndex];
  roundIdxEl.textContent = currentBatchIndex + 1;
  perRoundEl.textContent = batch.length;

  // set viewer to first question in batch
  if(batch[0] && batch[0].number){ viewIndex = batch[0].number; updateViewer(); }

  batch.forEach(item => {
    const uid = item._uid;
    const card = document.createElement('div');
    card.className = 'qcard';
    card.dataset.uid = uid;
    card.dataset.num = item.number;

    const typeLabel = item.type === 'mcq' ? 'MCQ' : item.type === 'multi' ? `Multi (max ${item.maxSelect || 4})` : 'Text';
    card.innerHTML = `<div class="qhead"><div>Q${item.number}${item.subject ? ' - '+item.subject : ''}</div><div class="small">${typeLabel}</div></div>`;

    if(item.type === 'text'){
      const input = document.createElement('input');
      input.className = 'inputText';
      input.placeholder = 'Type answer...';
      input.addEventListener('input', ()=> {
        if(revealed) return;
        const v = input.value.trim();
        if(v) selections[uid] = v;
        else delete selections[uid];
        updateSelectionState();
      });
      card.appendChild(input);
    } else {
      const opts = document.createElement('div');
      opts.className = 'opts';
      ['A','B','C','D'].forEach(letter => {
        const b = document.createElement('div');
        b.className = 'opt';
        b.tabIndex = 0;
        b.textContent = letter;
        b.addEventListener('click', ()=> {
          if(revealed) return;
          if(item.type === 'mcq'){
            Array.from(opts.children).forEach(c=>c.classList.remove('selected'));
            b.classList.add('selected');
            selections[uid] = letter;
            play(sClick);
          } else { // multi
            const sel = selections[uid] || [];
            const has = b.classList.contains('selected');
            if(!has){
              if(sel.length >= (item.maxSelect||4)) {
                b.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:220});
                return;
              }
              b.classList.add('selected');
              selections[uid] = [...sel, letter];
            } else {
              b.classList.remove('selected');
              selections[uid] = sel.filter(x=>x!==letter);
              if(selections[uid].length===0) delete selections[uid];
            }
            play(sClick);
          }
          updateSelectionState();
        });
        b.addEventListener('keydown', ev => { if(ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); b.click(); } });
        opts.appendChild(b);
      });
      card.appendChild(opts);
    }
    answersEl.appendChild(card);
  });

  updateSelectionState();
  nextBtnRound.style.display = 'none';
  confirmBtn.disabled = true;
}

/* ----------------- State helpers ----------------- */
function updateSelectionState(){
  const answered = Object.keys(selections).length;
  selectedCountEl.textContent = answered;
  const need = batches[currentBatchIndex]?.length || 0;
  confirmBtn.disabled = revealed || (answered < need);
}

/* ----------------- Confirm / Reveal (records attempts for report) ----------------- */
confirmBtn.addEventListener('click', ()=>{
  if(Object.keys(selections).length < (batches[currentBatchIndex]?.length || 0)){
    return alert('Answer all slots before confirming.');
  }
  revealed = true;
  let roundScore = 0;
  const batch = batches[currentBatchIndex];
  const batchWrong = [];

  batch.forEach(item => {
    const uid = item._uid;
    const qnum = item.number;
    const card = answersEl.querySelector(`.qcard[data-uid="${uid}"]`);
    if(!card) return;

    // ensure userAnswers entry exists
    userAnswers[qnum] = userAnswers[qnum] || { firstAttempt: null, secondAttempt: null, correct: item.correct, type: item.type, finalIsCorrect: false };

    if(item.type === 'text'){
      const input = card.querySelector('.inputText');
      const answer = (selections[uid]||'').toString().trim();
      const answerLower = answer.toLowerCase();
      const correct = (item.correct||'').toString().trim();
      input.disabled = true;
      card.querySelectorAll('.textResult').forEach(n => n.remove());

      const correctNow = (answerLower === correct.toLowerCase());
      if(correctNow){
        input.style.borderColor = '#1e693f';
        input.style.boxShadow = '0 6px 18px rgba(30,105,63,0.12)';
        roundScore++; play(sCorrect);
        const ok = document.createElement('span'); ok.className='textResult badge correct'; ok.textContent='Correct'; input.insertAdjacentElement('afterend', ok);
      } else {
        input.style.borderColor = '#a32727';
        input.style.boxShadow = '0 6px 18px rgba(163,39,39,0.12)';
        play(sWrong);
        batchWrong.push(item);
        const wrongBadge = document.createElement('span'); wrongBadge.className='textResult badge wrong'; wrongBadge.textContent='Wrong'; input.insertAdjacentElement('afterend', wrongBadge);
        const reveal = document.createElement('div'); reveal.className='note'; reveal.style.marginTop='8px';
        reveal.innerHTML = `<strong>Answer: </strong><span class="badge">${correct}</span>`;
        card.appendChild(reveal);
      }

      // record first/second attempts
      if(!secondChanceMode){
        if(userAnswers[qnum].firstAttempt == null) userAnswers[qnum].firstAttempt = answer || null;
      } else {
        userAnswers[qnum].secondAttempt = answer || null;
      }
      // update final correctness (second chance will overwrite)
      userAnswers[qnum].finalIsCorrect = !!correctNow;

    } else if(item.type === 'mcq'){
      const chosen = selections[uid] || null;
      const opts = card.querySelectorAll('.opt');
      opts.forEach(o => { const v = o.textContent; if(v === item.correct) o.classList.add('correct'); if(v===chosen && v!==item.correct) o.classList.add('wrong'); o.style.pointerEvents='none'; });
      const correctNow = (chosen === item.correct);
      if(correctNow){ roundScore++; play(sCorrect); } else { play(sWrong); batchWrong.push(item); }

      if(!secondChanceMode){
        if(userAnswers[qnum].firstAttempt == null) userAnswers[qnum].firstAttempt = chosen;
      } else {
        userAnswers[qnum].secondAttempt = chosen;
      }
      userAnswers[qnum].finalIsCorrect = !!correctNow;

    } else if(item.type === 'multi'){
      const chosen = (selections[uid]||[]).slice().sort();
      const correctSet = (item.correct||[]).slice().sort();
      const opts = card.querySelectorAll('.opt');
      opts.forEach(o => {
        const v = o.textContent;
        const isChosen = (selections[uid]||[]).includes(v);
        const isCorrect = (item.correct||[]).includes(v);
        if(isCorrect) o.classList.add('correct');
        if(isChosen && !isCorrect) o.classList.add('wrong');
        o.style.pointerEvents='none';
      });
      const equal = (a,b)=> a.length===b.length && a.every((v,i)=>v===b[i]);
      const correctNow = equal(correctSet, chosen);
      if(correctNow){ roundScore++; play(sCorrect); } else { play(sWrong); batchWrong.push(item); }

      if(!secondChanceMode){
        if(userAnswers[qnum].firstAttempt == null) userAnswers[qnum].firstAttempt = chosen.length ? chosen : null;
      } else {
        userAnswers[qnum].secondAttempt = chosen.length ? chosen : null;
      }
      userAnswers[qnum].finalIsCorrect = !!correctNow;
    }
  });

  if(!secondChanceMode && batchWrong.length) mainWrongPool.push(...batchWrong);
  accScore += roundScore; accScoreEl.textContent = accScore;

  if(currentBatchIndex < batches.length - 1){
    nextBtnRound.style.display = 'inline-block';
  } else {
    if(!secondChanceMode && mainWrongPool.length > 0){
      setTimeout(()=> triggerSecondChanceAuto(mainWrongPool), 650);
    } else {
      showFinal();
    }
  }

  confirmBtn.disabled = true;
});

/* ----------------- Second-chance flow (auto) ----------------- */
function dedupeByNumber(arr){
  const map = {};
  arr.forEach(it => map[it.number] = it);
  return Object.values(map);
}

function playCinematicOverlay(onComplete){
  const overlay = document.createElement('div');
  overlay.id = 'cinematic-overlay';
  overlay.style.position = 'fixed'; overlay.style.inset='0'; overlay.style.zIndex='99999';
  overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
  overlay.style.pointerEvents='none';

  // NOTE: title uses a readable color
  overlay.innerHTML = `
    <div class="cine-bar top" style="position:absolute;left:0;right:0;height:12vh;top:0;background:rgba(0,0,0,0.85);transform:translateY(-120%);"></div>
    <div class="cine-bar bottom" style="position:absolute;left:0;right:0;height:12vh;bottom:0;background:rgba(0,0,0,0.85);transform:translateY(120%);"></div>
    <div class="cine-title" style="color:#05393a;font-weight:900;font-size:32px;opacity:0;transform:translateY(32px);">SECOND CHANCE</div>
  `;
  document.body.appendChild(overlay);

  const top = overlay.querySelector('.cine-bar.top');
  const bottom = overlay.querySelector('.cine-bar.bottom');
  const title = overlay.querySelector('.cine-title');

  top.animate([{transform:'translateY(-120%)'},{transform:'translateY(6%)'},{transform:'translateY(0)'}], { duration:720, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards' });
  bottom.animate([{transform:'translateY(120%)'},{transform:'translateY(-6%)'},{transform:'translateY(0)'}], { duration:720, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards' });
  title.animate([{opacity:0, transform:'translateY(36px)'},{opacity:1, transform:'translateY(0)'}], { duration:850, easing:'cubic-bezier(.16,.9,.3,1)', delay:180, fill:'forwards' });

  const duration = 1400;
  setTimeout(()=>{
    overlay.animate([{opacity:1},{opacity:0}], { duration:380, fill:'forwards' });
    setTimeout(()=> { overlay.remove(); if(onComplete) onComplete(); }, 420);
  }, duration);
}

function triggerSecondChanceAuto(wrongArr){
  const deduped = dedupeByNumber(wrongArr);
  if(!deduped.length) { showFinal(); return; }

  playCinematicOverlay(()=> {
    document.body.classList.add('second-chance');
    wrapEl.classList.add('second-chance','intro');
    setTimeout(()=> wrapEl.classList.remove('intro'), 900);

    secondChancePool = deduped.map(x => ({...x}));
    secondChanceMode = true;
    prepareFromPool(secondChancePool, true);

    finalBoxHolder.innerHTML = `<div class="finalBox reveal"><h3>Second Chance ‚Äî Retry Wrong Questions üîÅ</h3><p class="small">You had <strong>${secondChancePool.length}</strong> missed question(s). Re-attempt them now.</p></div>`;
    setTimeout(()=> renderBatch(), 700);
  });
}

/* ----------------- Next / Retry / Reshuffle ----------------- */
nextBtnRound.addEventListener('click', ()=>{ currentBatchIndex++; renderBatch(); });
retrySameBtn.addEventListener('click', ()=> renderBatch());
reshuffleAllBtn.addEventListener('click', ()=> {
  if(secondChanceMode){ prepareFromPool(secondChancePool, true); renderBatch(); }
  else { prepareMain(); renderBatch(); viewIndex = 1; updateViewer(); }
});

/* ----------------- Final / Restart (includes review) ----------------- */
function showFinal(){
  if(!secondChanceMode){ wrapEl.classList.remove('second-chance'); document.body.classList.remove('second-chance'); }
  else { wrapEl.classList.add('second-chance'); document.body.classList.add('second-chance'); }

  finalBoxHolder.innerHTML = `<div class="finalBox reveal">
    <h3>All rounds complete üéâ</h3>
    <p class="small">Total correct: <strong>${accScore}</strong> / ${POOL.length}</p>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="btnPrimary" id="restartSame">Restart (same order)</button>
      <button class="btnGhost" id="restartShuffle">Restart (reshuffle)</button>
    </div>
  </div>`;
  document.getElementById('restartSame').addEventListener('click', ()=> {
    secondChanceMode = false; mainWrongPool = [];
    wrapEl.classList.remove('second-chance'); document.body.classList.remove('second-chance');
    prepareFromPool(POOL, false); accScore = 0; accScoreEl.textContent = accScore; renderBatch();
  });
  document.getElementById('restartShuffle').addEventListener('click', ()=> { prepareMain(); renderBatch(); });

  // show the review table below the final box
  showReview();
}

/* ----------------- Build Review Panel ----------------- */
function showReview(){
  // remove any existing review
  const existing = document.getElementById('review-panel');
  if(existing) existing.remove();

  const review = document.createElement('div');
  review.id = 'review-panel';
  review.style.marginTop = '12px';

  let correctCount = 0;
  let rows = '';

  // Show every POOL item (original order)
  POOL.forEach(q => {
    const ua = userAnswers[q.number] || { firstAttempt: null, secondAttempt: null, finalIsCorrect: false };
    const first = ua.firstAttempt == null ? '<em>‚Äî</em>' : (Array.isArray(ua.firstAttempt) ? ua.firstAttempt.join(', ') : ua.firstAttempt);
    const second = ua.secondAttempt == null ? '' : (Array.isArray(ua.secondAttempt) ? ua.secondAttempt.join(', ') : ua.secondAttempt);
    const correct = Array.isArray(q.correct) ? q.correct.join(', ') : q.correct;
    const finalCorrect = !!ua.finalIsCorrect;
    if(finalCorrect) correctCount++;

    const badgeHTML = finalCorrect ? `<span class="badge" style="background:#1e693f;color:#fff;padding:6px 10px;border-radius:8px;font-weight:800">Correct</span>` : `<span class="badge" style="background:#a32727;color:#fff;padding:6px 10px;border-radius:8px;font-weight:800">Wrong</span>`;

    rows += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,250,245,0.96));border:1px solid rgba(6,40,40,0.04);margin-bottom:8px">
      <div style="min-width:0">
        <strong>Q${q.number}</strong>
        <div class="small" style="margin-top:6px;color:var(--muted)">First: ${first} ${second ? `<span style="margin-left:8px">‚Ä¢ 2nd: ${second}</span>` : ''} <span style="margin-left:12px">‚Ä¢ Ans: ${correct}</span></div>
      </div>
      <div>${badgeHTML}</div>
    </div>`;
  });

  review.innerHTML = `<div class="finalBox reveal" style="padding:12px"><h3>Review ‚Äî All questions</h3>
    <div style="margin-top:10px">${rows}</div>
    <div style="margin-top:12px;text-align:center"><strong>Final correct: ${correctCount} / ${POOL.length}</strong></div>
  </div>`;

  finalBoxHolder.appendChild(review);
}

/* ----------------- Boot ----------------- */
function boot(){
  prepareMain(); attachViewer(); renderBatch(); updateViewer();
}
boot();


</script>
</body>
</html>
